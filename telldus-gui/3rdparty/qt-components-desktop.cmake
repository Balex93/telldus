FIND_PACKAGE( Qt4 REQUIRED )

SET(BASE_PATH "${CMAKE_SOURCE_DIR}/3rdparty/qt-components-desktop")
FILE(GLOB SRCS ${BASE_PATH}/src/*.cpp)
FILE(GLOB HDRS ${BASE_PATH}/src/*.h)

FILE(GLOB_RECURSE QML ${BASE_PATH}/components/*.qml)
FILE(GLOB_RECURSE JS ${BASE_PATH}/components/*.js)
FILE(GLOB_RECURSE PNG ${BASE_PATH}/components/*.png)
FILE(GLOB_RECURSE QMLDIR ${BASE_PATH}/components/qmldir)
SET(EXTRA_FILES ${QML} ${JS} ${PNG} ${QMLDIR})

IF (QT_COMPONENTS_OUTPUT_DIR)
	SET(QT_COMPONENTS_OUTPUT_DIR "${QT_COMPONENTS_OUTPUT_DIR}/QtDesktop")
ELSE()
	SET(QT_COMPONENTS_OUTPUT_DIR "QtDesktop")
ENDIF()

STRING(LENGTH "${BASE_PATH}/components" BASE_LENGTH)
FOREACH(_FILE ${EXTRA_FILES})
	STRING(LENGTH ${_FILE} _FILE_LENGTH)
	MATH(EXPR _TOP_LENGTH "${_FILE_LENGTH}-${BASE_LENGTH}")
	STRING(SUBSTRING ${_FILE} ${BASE_LENGTH} ${_TOP_LENGTH} _OUT_FILE)
	GET_FILENAME_COMPONENT(_FILENAME ${_FILE} NAME)
	SET(_OUTFILEPATH ${QT_COMPONENTS_OUTPUT_DIR}${_OUT_FILE})
	LIST(APPEND SRCS ${_OUTFILEPATH})
	ADD_CUSTOM_COMMAND(
		OUTPUT ${_OUTFILEPATH}
		DEPENDS ${_FILE}
		COMMAND ${CMAKE_COMMAND} -E copy ${_FILE} ${_OUTFILEPATH}
		COMMENT "Copy ${_FILENAME} to destination"
	)
ENDFOREACH(_FILE)

QT4_WRAP_CPP( MOC_SRCS  ${HDRS} )
QT4_AUTOMOC ( ${SRCS} )

SET(LIBRARIES ${QT_LIBRARIES})

IF (APPLE)
	FIND_LIBRARY(CARBON_LIBRARY Carbon)
	LIST(APPEND LIBRARIES ${CARBON_LIBRARY})
ENDIF ()

ADD_LIBRARY(styleplugin SHARED
	${SRCS}
	${MOC_SRCS}
)
TARGET_LINK_LIBRARIES( styleplugin ${LIBRARIES} )

IF (WIN32)
	SET_TARGET_PROPERTIES(styleplugin PROPERTIES
		PREFIX "Plugins/declarative/QtDesktop/plugin/"
	)
ELSE()
	SET_TARGET_PROPERTIES(styleplugin PROPERTIES
		LIBRARY_OUTPUT_DIRECTORY ${QT_COMPONENTS_OUTPUT_DIR}/plugin
	)
ENDIF()
